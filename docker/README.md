# Docker image for Hermes

This document describes the Docker setup for building and running the Hermes-3 and BOUT++ plasma simulation frameworks. It outlines the purpose of the `Dockerfile`, the `docker-compose.yml` services, and provides instructions on how to interact with the Docker image.

## Overview

This Docker configuration provides a containerized environment for building and running Hermes-3. It's designed to be flexible, allowing you to build the software and run simulations using files from your local machine, and even modify the source code and build configurations within the container by leveraging the `work` folder.

## Basic Getting Started

This guide will walk you through the quickest way to run a Hermes-3 simulation using the Docker image.

1.  **Navigate to the `docker` directory:** Open your terminal and change the current directory to the `docker` folder within your Hermes-3 repository:
    ```bash
    cd docker
    ```

2.  **Set up the environment:** Run the `setup.sh` script. This will create a `.env` file with necessary configurations for `docker compose` and a `work` subfolder. The `work` folder will be your central point for transferring simulation files to and from the Docker container, and for overriding default builds.
    ```bash
    ./setup.sh
    ```

3.  **Prepare your simulation case:** Create a subdirectory within `work` named `case` (if it doesn't exist) and copy your `BOUT.inp` simulation configuration file into it. For example:
    ```bash
    mkdir -p work/case
    cp /path/to/your/BOUT.inp work/case/
    ```

4.  **Run the simulation:** Execute the following `docker compose` command. This will start a temporary container based on the `hermes` service defined in `docker-compose.yml`, run the Hermes-3 executable with your `BOUT.inp` file located in `work/case`, and automatically remove the container once the simulation is finished.
    ```bash
    docker compose run --rm hermes work/case
    ```
    You should see the output of your Hermes-3 simulation in the terminal. Any output files generated by the simulation will be located in the `work/case` folder on your local machine.

## Overriding Default Builds using the `work` Folder

The `work` folder on your local machine is mounted to the `/hermes_project/work` directory inside the Docker container. This allows you to override the default builds of BOUT++ and Hermes-3 that are included in the image by placing your own source code and configuration files within the `work` folder. The build scripts inside the container are designed to prioritize these files if they exist.

Here's how you can leverage the `work` folder to customize the build:

1.  **Modifying BOUT++ Source Code:**
    * Clone the BOUT++ repository into the `work` folder on your local machine. **Important:** The directory must be named exactly `BOUT-dev`.
        ```bash
        git clone https://github.com/boutproject/BOUT-dev.git work/BOUT-dev
        ```
    * When you run `docker compose run --rm build_boutpp` or `docker compose run --rm build_both`, the build process will detect the `BOUT-dev` directory in `work` and use this source code instead of the version built into the image.

2.  **Modifying Hermes-3 Source Code:**
    * Clone the Hermes-3 repository into the `work` folder on your local machine. **Important:** The directory must be named exactly `hermes-3`.
        ```bash
        git clone https://github.com/boutproject/hermes-3.git work/hermes-3
        ```
    * When you run `docker compose run --rm build_hermes` or `docker compose run --rm build_both`, the build process will detect the `hermes-3` directory in `work` and use this source code instead of the default.

3.  **Providing Custom Configuration Files:**
    * If you need to change the CMake build options for BOUT++, create a file named `boutpp_config.cmake` and place it directly inside the `work` folder on your local machine.
    * Similarly, for custom Hermes-3 build options, create a file named `hermes_config.cmake` and place it directly inside the `work` folder.
    * When the build scripts run, they will check for these configuration files in the `work` folder and use them in preference to the default configuration files included in the image.

By placing your source code and configuration files in the correctly named locations within the `work` folder, you can effectively override the default build process and use your own customized versions of BOUT++ and Hermes-3 within the Docker environment without needing to rebuild the entire Docker image.

## Interacting with the Image using `image` Commands

The Docker image includes a set of pre-defined commands accessible via the `/bin/image` script within the container. These commands simplify common tasks such as building the code and running simulations. When you use `docker compose run --rm <service> <command> <arguments>`, you are essentially executing this `/bin/image` script with the specified `<command>` and `<arguments>`. The `image` command is defined by the `image_ingredients/docker_image_commands.sh` file.

Here's a breakdown of the available commands:

* **`build_boutpp`**: This command is used to configure and build the BOUT++ framework. It looks for the BOUT++ source code in `/hermes_project/work/BOUT-dev` (if this directory exists; otherwise, it uses the version included when the image was built). It uses the configuration file located at `/hermes_project/work/boutpp_config.cmake` (if it exists; otherwise, it uses the default). The build output is placed in `/hermes_project/build/boutpp-build`.

* **`build_hermes`**: This command configures and builds the Hermes-3 model. It searches for the Hermes-3 source code in `/hermes_project/work/hermes-3` (overriding the built-in version if present) and uses the configuration file at `/hermes_project/work/hermes_config.cmake` (or the default). It depends on a previously built BOUT++ (using the `build_boutpp` command or the BOUT++ built into the image) and places the resulting executable in `/hermes_project/build/hermes-3-build`.

* **`build_both`**: This is a convenience command that sequentially executes `build_boutpp` followed by `build_hermes`.

* **`run <directory>`**: This command executes the compiled Hermes-3 model. You must provide a `<directory>` argument, which should correspond to a subdirectory within the `work` folder on your local machine (e.g., `work/case`). The command checks for a `BOUT.inp` file within this directory and then runs the Hermes-3 executable, passing the specified directory as the working directory for the simulation.

* **`build_hermes_and_run <directory>`**: This command first builds the Hermes-3 model (using the same logic as `build_hermes`) and then immediately runs it in the specified `<directory>` (similar to the `run` command).

* **`build_both_and_run <directory>`**: This command first builds both BOUT++ and Hermes-3 (like the `build_both` command) and then executes the Hermes-3 model in the provided `<directory>`.

* **`fix_permissions`**: This command adjusts the ownership of the `/hermes_project/work` directory within the container to match the user and group IDs of your host machine. This is useful when you encounter permission issues when trying to access or modify files in the `work` folder from within a container started with root privileges (e.g., using `docker compose run --rm sudo`).

When you use commands like `docker compose run --rm hermes work/case`, the `docker-compose.yml` defines the `hermes` service in a way that effectively runs `/bin/image run work/case` inside the container. Similarly, `docker compose run --rm build_hermes` executes `/bin/image build_hermes`.

## How the Docker Image is Built (`Dockerfile` Explained)

The `Dockerfile` contains the instructions for building the Docker image layer by layer. Here's a breakdown of the key stages:

1.  **Base Image (`FROM spack/ubuntu-jammy@sha256:d9acf9ed998cbde8d12bd302c5921291086bfe6f70d2d0e26908fdc48c272324 AS builder`)**:
    * The process starts by using a pre-built Docker image from Spack (a package manager for scientific computing) based on Ubuntu 22.04 (Jammy Jellyfish). This image already has Spack installed, which significantly speeds up the build process for scientific software.
    * The `AS builder` part gives this stage a name, "builder", which allows later stages to copy files from it.

2.  **Installing OS Dependencies (`RUN apt-get ...`)**:
    * This step updates the package lists and installs essential system packages required for building software, such as `git`, `build-essential` (which includes `gcc`, `g++`, `make`, etc.), `vim`, and `cmake`. Unnecessary package lists are then removed to reduce the image size.

3.  **Spack Configuration (`COPY docker/image_ingredients/docker_spack.yaml ...`, `WORKDIR ...`, `RUN spack env activate . && spack install --fail-fast && spack gc -y`)**:
    * A `spack.yaml` file, which specifies the desired software packages (including BOUT++ and Hermes-3, along with their dependencies and build options), is copied into the `/opt/spack-environment` directory.
    * Spack is then activated in this environment, and the software packages defined in `spack.yaml` are installed. The `--fail-fast` option stops the installation immediately if any package fails to build.
    * Finally, `spack gc -y` performs garbage collection, removing any unnecessary files left over from the build process, further optimizing the image size.

4.  **Creating the Activation Script (`RUN spack env activate --sh -d . > activate.sh`)**:
    * This command generates a shell script (`activate.sh`) that, when sourced, activates the Spack environment where BOUT++ and Hermes-3 are installed. This script is crucial for making the installed software accessible in later stages.

5.  **Final Runtime Image (`FROM ubuntu:22.04`)**:
    * A new, minimal Ubuntu 22.04 image is used as the base for the final runtime container. This keeps the production image lean by only including necessary components.

6.  **Copying Built Software (`COPY --from=builder ...`)**:
    * The compiled BOUT++ and Hermes-3 installations, along with the Spack environment and views (symlinked installation directories), are copied from the `builder` stage into the current image. This ensures that the final image contains the built software without needing to rebuild it.

7.  **Installing Runtime Dependencies (`RUN apt-get ...`)**:
    * Essential tools like `git`, `build-essential`, `vim`, and `cmake` are installed in the runtime image. These are useful for users who might want to interact with the container and potentially rebuild or run other tools.

8.  **Setting up Working Directories and Environment Variables (`WORKDIR /hermes_project`, `ENV ...`)**:
    * The default working directory inside the container is set to `/hermes_project`.
    * Environment variables are defined to specify the locations of the source code, build directories, and configuration files for both Hermes-3 and BOUT++. Importantly, `*_OVERRIDE` variables are defined to point to the `work` directory, allowing users to mount their local source code and configuration files, which will take precedence over the built-in versions.

9.  **Copying Hermes-3 Source and Patches (`COPY . ${HERMES_SRC_DIR}`, `COPY docker/image_ingredients/enable_c.patch ...`, `RUN git ...`)**:
    * The Hermes-3 source code from the repository is copied into the designated source directory.
    * A specific patch (`enable_c.patch`) is applied to the BOUT++ source code. This likely addresses a compatibility issue or enables specific features.

10. **Copying Default Configuration Files (`COPY docker/image_ingredients/boutpp_config.cmake ...`, `COPY docker/image_ingredients/hermes_config.cmake ...`)**:
    * Default CMake configuration files for BOUT++ and Hermes-3 are copied into their respective configuration directories. These will be used unless overridden by files in the `work` directory.

11. **Configuring and Building BOUT++ and Hermes-3 (`RUN . /opt/spack-environment/activate.sh && cmake ... && cmake --build ...`)**:
    * The Spack environment is activated using the `activate.sh` script.
    * CMake is then used to configure the build for both BOUT++ and Hermes-3, using the specified source and configuration directories. The `-DCMAKE_PREFIX_PATH` option ensures that Hermes-3 can find the BOUT++ installation.
    * Finally, the `cmake --build` command compiles the code in parallel (`--parallel`).

12. **Copying Helper Commands (`COPY docker/image_ingredients/docker_image_commands.sh /bin/image`, `RUN chmod ...`)**:
    * The `docker_image_commands.sh` script (which you provided) is copied into the `/bin` directory and made executable. This script provides the `build_boutpp`, `build_hermes`, `run`, etc., commands.

13. **Copying Entrypoint Script (`COPY docker/image_ingredients/docker_entrypoint.sh /entrypoint.sh`, `RUN chmod ...`)**:
    * A script named `docker_entrypoint.sh` is copied to `/` and made executable. This script is executed when the container starts. It likely performs initial setup or defers to the command provided when running the container (e.g., the `/bin/image` script).

14. **Setting Entrypoint and Default Command (`ENTRYPOINT [ "/entrypoint.sh" ]`, `CMD [ "/bin/bash"]`)**:
    * The `ENTRYPOINT` instruction specifies the default executable to run when the container starts. Here, it's the `/entrypoint.sh` script.
    * The `CMD` instruction provides default arguments to the `ENTRYPOINT`. If no command is specified when running the container (e.g., `docker run <image>`), it will default to `/bin/bash`, providing an interactive shell within the container.

## Help!!! I don't have permission to delete the `hermes-3-docker/work` folder

One somewhat annoying problem with using this docker image is the possibility that you end up with files in the `hermes-3-docker/work` folder that you don't have permission to delete. If you still have the `docker-compose.yaml` and `.env` file available, you can run `docker compose run --rm fix-permissions` and then proceed with deleting the `hermes-3-docker/work` folder. However, if you've already deleted these files, run the following command
```
docker run --rm -v "${PWD}/hermes-3-docker/work:/hermes_project/work" -e "PUID=$(id -u)" -e "PGID=$(id -g)" ghcr.io/boutproject/hermes-3 image fix_permissions
```
to adjust the permissions of `./hermes-3-docker/work`. You should then be able to `rm -rf hermes-3-docker/work`.

